package derivation

import (
	"context"
	"crypto/ecdsa"
	"encoding/json"
	"fmt"
	"github.com/morph-l2/bindings/bindings"
	"github.com/scroll-tech/go-ethereum/common/hexutil"
	"github.com/scroll-tech/go-ethereum/eth"
	"math"
	"math/big"
	"os"
	"reflect"
	"strings"
	"testing"

	"github.com/morph-l2/node/types"
	"github.com/scroll-tech/go-ethereum"
	"github.com/scroll-tech/go-ethereum/accounts/abi/bind"
	"github.com/scroll-tech/go-ethereum/accounts/abi/bind/backends"
	"github.com/scroll-tech/go-ethereum/common"
	"github.com/scroll-tech/go-ethereum/core"
	"github.com/scroll-tech/go-ethereum/core/rawdb"
	"github.com/scroll-tech/go-ethereum/ethclient"
	"github.com/scroll-tech/go-ethereum/ethclient/authclient"
	"github.com/scroll-tech/go-ethereum/ethdb"
	"github.com/scroll-tech/go-ethereum/rpc"
	"github.com/stretchr/testify/require"
	tmlog "github.com/tendermint/tendermint/libs/log"
)

func TestCompareBlock(t *testing.T) {
	eClient, err := ethclient.Dial("http://localhost:7545")
	require.NoError(t, err)
	l2Client, err := ethclient.Dial("http://localhost:8545")
	blockNumber, err := eClient.BlockNumber(context.Background())
	require.NoError(t, err)
	for i := 0; i < int(blockNumber); i++ {
		block, err := l2Client.BlockByNumber(context.Background(), big.NewInt(int64(i)))
		require.NoError(t, err)
		dBlock, err := eClient.BlockByNumber(context.Background(), big.NewInt(int64(i)))
		require.True(t, reflect.DeepEqual(block.Header(), dBlock.Header()))
	}
}

func testNewDerivationClient(t *testing.T) *Derivation {
	ctx := context.Background()
	l1Client, err := ethclient.Dial("http://localhost:9545")
	addr := common.HexToAddress("0x6900000000000000000000000000000000000010")
	require.NoError(t, err)
	var secret [32]byte
	jwtSecret := common.FromHex(strings.TrimSpace("688f5d737bad920bdfb2fc2f488d6b6209eebda1dae949a8de91398d932c517a"))
	require.True(t, len(jwtSecret) == 32)
	copy(secret[:], jwtSecret)
	aClient, err := authclient.DialContext(context.Background(), "http://localhost:7551", secret)
	require.NoError(t, err)
	eClient, err := ethclient.Dial("http://localhost:7545")
	require.NoError(t, err)
	d := Derivation{
		ctx:                   ctx,
		l1Client:              l1Client,
		RollupContractAddress: addr,
		confirmations:         rpc.BlockNumber(5),
		l2Client:              types.NewRetryableClient(aClient, eClient, tmlog.NewTMLogger(tmlog.NewSyncWriter(os.Stdout))),
		validator:             nil,
		latestDerivation:      9,
		fetchBlockRange:       100,
		pollInterval:          1,
	}
	return &d
}

func TestFetchRollupData(t *testing.T) {
	d := testNewDerivationClient(t)
	logs, err := d.fetchRollupLog(context.Background(), 1, 1000)
	require.NoError(t, err)
	for _, lg := range logs {
		rollupData, err := d.fetchRollupDataByTxHash(lg.TxHash, lg.BlockNumber)
		if err != nil {
			d.logger.Error("fetch rollup data failed", "txHash", lg.TxHash, "blockNumber", lg.BlockNumber)
			return
		}
		d.logger.Info("fetch rollup transaction success", "txNonce", rollupData.Nonce, "txHash", rollupData.TxHash,
			"l1BlockNumber", rollupData.L1BlockNumber, "firstL2BlockNumber", rollupData.FirstBlockNumber, "lastL2BlockNumber", rollupData.LastBlockNumber)

	}
}

func newSimulatedBackend(key *ecdsa.PrivateKey) (*backends.SimulatedBackend, ethdb.Database) {
	var gasLimit uint64 = 9_000_000
	auth, _ := bind.NewKeyedTransactorWithChainID(key, big.NewInt(1337))
	genAlloc := make(core.GenesisAlloc)
	genAlloc[auth.From] = core.GenesisAccount{Balance: big.NewInt(9223372036854775807)}
	db := rawdb.NewMemoryDatabase()
	sim := backends.NewSimulatedBackendWithDatabase(db, genAlloc, gasLimit)
	return sim, db
}

func TestFindBatchIndex(t *testing.T) {
	d := testNewDerivationClient(t)
	query := ethereum.FilterQuery{
		FromBlock: big.NewInt(0).SetUint64(1),
		ToBlock:   big.NewInt(0).SetUint64(2000),
		Addresses: []common.Address{
			d.RollupContractAddress,
		},
		Topics: [][]common.Hash{
			{RollupEventTopicHash},
		},
	}
	rollup, err := bindings.NewRollup(d.RollupContractAddress, d.l1Client)
	require.NoError(t, err)
	d.rollup = rollup
	logs, err := d.l1Client.FilterLogs(context.Background(), query)
	require.NoError(t, err)
	require.True(t, len(logs) != 0)
	for _, lg := range logs {
		batchIndex, err := d.findBatchIndex(lg.TxHash, 20)
		if err != nil {
			continue
		}
		require.NotZero(t, batchIndex)
		break
	}
}

func TestNewDerivationClient(t *testing.T) {
	//firstInput := "0xfabef37f000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006500000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000002425be944cc380f8d876b3961d0ca200822491d73502ac46e158328ae67f0af227ae5ba08d7291c96c8cbddcc148bf48a6d68c7974b94356f53754ef6171d75700000000000000000000000000000000000000000000000000000000000023600000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220800000000000000000000000000000000000000000000000000000000000000030000000064d5c10c00000000000000000000000000000000000000000000000000000000000000000000000001c86c88000000000000000000000000000000000000000000000000000000000000000000000000000000040000000064d5c11200000000000000000000000000000000000000000000000000000000000000000000000001c7fa6e000000000000000000000000000000000000000000000000000000000000000000000000000000050000000064d5c11800000000000000000000000000000000000000000000000000000000000000000000000001c78871000000000000000000000000000000000000000000000000000000000000000000000000000000060000000064d5c11e00000000000000000000000000000000000000000000000000000000000000000000000001c71690000000000000000000000000000000000000000000000000000000000000000000000000000000070000000064d5c12400000000000000000000000000000000000000000000000000000000000000000000000001c6a4cc000000000000000000000000000000000000000000000000000000000000000000000000000000080000000064d5c12a00000000000000000000000000000000000000000000000000000000000000000000000001c63324000000000000000000000000000000000000000000000000000000000000000000000000000000090000000064d5c13000000000000000000000000000000000000000000000000000000000000000000000000001c5c1990000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000064d5c13600000000000000000000000000000000000000000000000000000000000000000000000001c5502a0000000000000000000000000000000000000000000000000000000000000000000000000000000b0000000064d5c13c00000000000000000000000000000000000000000000000000000000000000000000000001c4ded70000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000064d5c14200000000000000000000000000000000000000000000000000000000000000000000000001c46da10000000000000000000000000000000000000000000000000000000000000000000000000000000d0000000064d5c14800000000000000000000000000000000000000000000000000000000000000000000000001c3fc870000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000064d5c14e00000000000000000000000000000000000000000000000000000000000000000000000001c38b890000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000064d5c15400000000000000000000000000000000000000000000000000000000000000000000000001c31aa8000000000000000000000000000000000000000000000000000000000000000000000000000000100000000064d5c15a00000000000000000000000000000000000000000000000000000000000000000000000001c2a9e3000000000000000000000000000000000000000000000000000000000000000000000000000000110000000064d5c16000000000000000000000000000000000000000000000000000000000000000000000000001c2393a000000000000000000000000000000000000000000000000000000000000000000000000000000120000000064d5c16600000000000000000000000000000000000000000000000000000000000000000000000001c1c8ad000000000000000000000000000000000000000000000000000000000000000000000000000000130000000064d5c16c00000000000000000000000000000000000000000000000000000000000000000000000001c1583c000000000000000000000000000000000000000000000000000000000000000000000000000000140000000064d5c17300000000000000000000000000000000000000000000000000000000000000000000000001c0e7e7000000000000000000000000000000000000000000000000000000000000000000000000000000150000000064d5c17900000000000000000000000000000000000000000000000000000000000000000000000001c077af000000000000000000000000000000000000000000000000000000000000000000000000000000160000000064d5c17f00000000000000000000000000000000000000000000000000000000000000000000000001c00793000000000000000000000000000000000000000000000000000000000000000000000000000000170000000064d5c18500000000000000000000000000000000000000000000000000000000000000000000000001bf9793000000000000000000000000000000000000000000000000000000000000000000000000000000180000000064d5c18b00000000000000000000000000000000000000000000000000000000000000000000000001bf27af000000000000000000000000000000000000000000000000000000000000000000000000000000190000000064d5c19100000000000000000000000000000000000000000000000000000000000000000000000001beb7e70000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000064d5c19700000000000000000000000000000000000000000000000000000000000000000000000001be483b0000000000000000000000000000000000000000000000000000000000000000000000000000001b0000000064d5c19d00000000000000000000000000000000000000000000000000000000000000000000000001bdd8aa0000000000000000000000000000000000000000000000000000000000000000000000000000001c0000000064d5c1a300000000000000000000000000000000000000000000000000000000000000000000000001bd69350000000000000000000000000000000000000000000000000000000000000000000000000000001d0000000064d5c1a900000000000000000000000000000000000000000000000000000000000000000000000001bcf9dc0000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000064d5c1af00000000000000000000000000000000000000000000000000000000000000000000000001bc8a9f0000000000000000000000000000000000000000000000000000000000000000000000000000001f0000000064d5c1b500000000000000000000000000000000000000000000000000000000000000000000000001bc1b7e000000000000000000000000000000000000000000000000000000000000000000000000000000200000000064d5c1bb00000000000000000000000000000000000000000000000000000000000000000000000001bbac79000000000000000000000000000000000000000000000000000000000000000000000000000000210000000064d5c1c100000000000000000000000000000000000000000000000000000000000000000000000001bb3d8f000000000000000000000000000000000000000000000000000000000000000000000000000000220000000064d5c1c700000000000000000000000000000000000000000000000000000000000000000000000001bacec1000000000000000000000000000000000000000000000000000000000000000000000000000000230000000064d5c1cd00000000000000000000000000000000000000000000000000000000000000000000000001ba600f000000000000000000000000000000000000000000000000000000000000000000000000000000240000000064d5c1d300000000000000000000000000000000000000000000000000000000000000000000000001b9f178000000000000000000000000000000000000000000000000000000000000000000000000000000250000000064d5c1d900000000000000000000000000000000000000000000000000000000000000000000000001b982fd000000000000000000000000000000000000000000000000000000000000000000000000000000260000000064d5c1df00000000000000000000000000000000000000000000000000000000000000000000000001b9149e000000000000000000000000000000000000000000000000000000000000000000000000000000270000000064d5c1e500000000000000000000000000000000000000000000000000000000000000000000000001b8a65a000000000000000000000000000000000000000000000000000000000000000000000000000000280000000064d5c1eb00000000000000000000000000000000000000000000000000000000000000000000000001b83832000000000000000000000000000000000000000000000000000000000000000000000000000000290000000064d5c1f100000000000000000000000000000000000000000000000000000000000000000000000001b7ca250000000000000000000000000000000000000000000000000000000000000000000000000000002a0000000064d5c1f700000000000000000000000000000000000000000000000000000000000000000000000001b75c340000000000000000000000000000000000000000000000000000000000000000000000000000002b0000000064d5c1fd00000000000000000000000000000000000000000000000000000000000000000000000001b6ee5e0000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000064d5c20300000000000000000000000000000000000000000000000000000000000000000000000001b680a40000000000000000000000000000000000000000000000000000000000000000000000000000002d0000000064d5c20900000000000000000000000000000000000000000000000000000000000000000000000001b613050000000000000000000000000000000000000000000000000000000000000000000000000000002e0000000064d5c20f00000000000000000000000000000000000000000000000000000000000000000000000001b5a5820000000000000000000000000000000000000000000000000000000000000000000000000000002f0000000064d5c21500000000000000000000000000000000000000000000000000000000000000000000000001b5381a000000000000000000000000000000000000000000000000000000000000000000000000000000300000000064d5c21b00000000000000000000000000000000000000000000000000000000000000000000000001b4cacd000000000000000000000000000000000000000000000000000000000000000000000000000000310000000064d5c22100000000000000000000000000000000000000000000000000000000000000000000000001b45d9c000000000000000000000000000000000000000000000000000000000000000000000000000000320000000064d5c22700000000000000000000000000000000000000000000000000000000000000000000000001b3f086000000000000000000000000000000000000000000000000000000000000000000000000000000330000000064d5c22d00000000000000000000000000000000000000000000000000000000000000000000000001b3838b000000000000000000000000000000000000000000000000000000000000000000000000000000340000000064d5c23300000000000000000000000000000000000000000000000000000000000000000000000001b316ac000000000000000000000000000000000000000000000000000000000000000000000000000000350000000064d5c23900000000000000000000000000000000000000000000000000000000000000000000000001b2a9e8000000000000000000000000000000000000000000000000000000000000000000000000000000360000000064d5c23f00000000000000000000000000000000000000000000000000000000000000000000000001b23d3f000000000000000000000000000000000000000000000000000000000000000000000000000000370000000064d5c24500000000000000000000000000000000000000000000000000000000000000000000000001b1d0b1000000000000000000000000000000000000000000000000000000000000000000000000000000380000000064d5c24b00000000000000000000000000000000000000000000000000000000000000000000000001b1643e000000000000000000000000000000000000000000000000000000000000000000000000000000390000000064d5c25100000000000000000000000000000000000000000000000000000000000000000000000001b0f7e60000000000000000000000000000000000000000000000000000000000000000000000000000003a0000000064d5c25700000000000000000000000000000000000000000000000000000000000000000000000001b08baa0000000000000000000000000000000000000000000000000000000000000000000000000000003b0000000064d5c25d00000000000000000000000000000000000000000000000000000000000000000000000001b01f890000000000000000000000000000000000000000000000000000000000000000000000000000003c0000000064d5c26300000000000000000000000000000000000000000000000000000000000000000000000001afb3830000000000000000000000000000000000000000000000000000000000000000000000000000003d0000000064d5c26900000000000000000000000000000000000000000000000000000000000000000000000001af47980000000000000000000000000000000000000000000000000000000000000000000000000000003e0000000064d5c26f00000000000000000000000000000000000000000000000000000000000000000000000001aedbc80000000000000000000000000000000000000000000000000000000000000000000000000000003f0000000064d5c27600000000000000000000000000000000000000000000000000000000000000000000000001ae7013000000000000000000000000000000000000000000000000000000000000000000000000000000400000000064d5c27c00000000000000000000000000000000000000000000000000000000000000000000000001ae0478000000000000000000000000000000000000000000000000000000000000000000000000000000410000000064d5c28200000000000000000000000000000000000000000000000000000000000000000000000001ad98f8000000000000000000000000000000000000000000000000000000000000000000000000000000420000000064d5c28800000000000000000000000000000000000000000000000000000000000000000000000001ad2d93000000000000000000000000000000000000000000000000000000000000000000000000000000430000000064d5c28e00000000000000000000000000000000000000000000000000000000000000000000000001acc249000000000000000000000000000000000000000000000000000000000000000000000000000000440000000064d5c29400000000000000000000000000000000000000000000000000000000000000000000000001ac571a000000000000000000000000000000000000000000000000000000000000000000000000000000450000000064d5c29a00000000000000000000000000000000000000000000000000000000000000000000000001abec06000000000000000000000000000000000000000000000000000000000000000000000000000000460000000064d5c2a000000000000000000000000000000000000000000000000000000000000000000000000001ab810c000000000000000000000000000000000000000000000000000000000000000000000000000000470000000064d5c2a600000000000000000000000000000000000000000000000000000000000000000000000001ab162d000000000000000000000000000000000000000000000000000000000000000000000000000000480000000064d5c2ac00000000000000000000000000000000000000000000000000000000000000000000000001aaab69000000000000000000000000000000000000000000000000000000000000000000000000000000490000000064d5c2b200000000000000000000000000000000000000000000000000000000000000000000000001aa40c00000000000000000000000000000000000000000000000000000000000000000000000000000004a0000000064d5c2b800000000000000000000000000000000000000000000000000000000000000000000000001a9d6310000000000000000000000000000000000000000000000000000000000000000000000000000004b0000000064d5c2be00000000000000000000000000000000000000000000000000000000000000000000000001a96bbd0000000000000000000000000000000000000000000000000000000000000000000000000000004c0000000064d5c2c400000000000000000000000000000000000000000000000000000000000000000000000001a901640000000000000000000000000000000000000000000000000000000000000000000000000000004d0000000064d5c2ca00000000000000000000000000000000000000000000000000000000000000000000000001a897250000000000000000000000000000000000000000000000000000000000000000000000000000004e0000000064d5c2d000000000000000000000000000000000000000000000000000000000000000000000000001a82d010000000000000000000000000000000000000000000000000000000000000000000000000000004f0000000064d5c2d600000000000000000000000000000000000000000000000000000000000000000000000001a7c2f7000000000000000000000000000000000000000000000000000000000000000000000000000000500000000064d5c2dc00000000000000000000000000000000000000000000000000000000000000000000000001a75908000000000000000000000000000000000000000000000000000000000000000000000000000000510000000064d5c2e200000000000000000000000000000000000000000000000000000000000000000000000001a6ef33000000000000000000000000000000000000000000000000000000000000000000000000000000520000000064d5c2e800000000000000000000000000000000000000000000000000000000000000000000000001a68579000000000000000000000000000000000000000000000000000000000000000000000000000000530000000064d5c2ee00000000000000000000000000000000000000000000000000000000000000000000000001a61bd9000000000000000000000000000000000000000000000000000000000000000000000000000000540000000064d5c2f400000000000000000000000000000000000000000000000000000000000000000000000001a5b254000000000000000000000000000000000000000000000000000000000000000000000000000000550000000064d5c2fa00000000000000000000000000000000000000000000000000000000000000000000000001a548e9000000000000000000000000000000000000000000000000000000000000000000000000000000560000000064d5c30000000000000000000000000000000000000000000000000000000000000000000000000001a4df98000000000000000000000000000000000000000000000000000000000000000000000000000000570000000064d5c30600000000000000000000000000000000000000000000000000000000000000000000000001a47662000000000000000000000000000000000000000000000000000000000000000000000000000000580000000064d5c30c00000000000000000000000000000000000000000000000000000000000000000000000001a40d46000000000000000000000000000000000000000000000000000000000000000000000000000000590000000064d5c31200000000000000000000000000000000000000000000000000000000000000000000000001a3a4440000000000000000000000000000000000000000000000000000000000000000000000000000005a0000000064d5c31800000000000000000000000000000000000000000000000000000000000000000000000001a33b5c0000000000000000000000000000000000000000000000000000000000000000000000000000005b0000000064d5c31e00000000000000000000000000000000000000000000000000000000000000000000000001a2d28f0000000000000000000000000000000000000000000000000000000000000000000000000000005c0000000064d5c32400000000000000000000000000000000000000000000000000000000000000000000000001a269dc0000000000000000000000000000000000000000000000000000000000000000000000000000005d0000000064d5c32a00000000000000000000000000000000000000000000000000000000000000000000000001a201430000000000000000000000000000000000000000000000000000000000000000000000000000005e0000000064d5c33000000000000000000000000000000000000000000000000000000000000000000000000001a198c40000000000000000000000000000000000000000000000000000000000000000000000000000005f0000000064d5c33600000000000000000000000000000000000000000000000000000000000000000000000001a1305f000000000000000000000000000000000000000000000000000000000000000000000000000000600000000064d5c33c00000000000000000000000000000000000000000000000000000000000000000000000001a0c814000000000000000000000000000000000000000000000000000000000000000000000000000000610000000064d5c34200000000000000000000000000000000000000000000000000000000000000000000000001a05fe3000000000000000000000000000000000000000000000000000000000000000000000000000000620000000064d5c348000000000000000000000000000000000000000000000000000000000000000000000000019ff7cd000000000000000000000000000000000000000000000000000000000000000000000000000000630000000064d5c34e000000000000000000000000000000000000000000000000000000000000000000000000019f8fd1000000000000000000000000000000000000000000000000000000000000000000000000000000640000000064d5c355000000000000000000000000000000000000000000000000000000000000000000000000019f27ef000000000000000000000000000000000000000000000000000000000000000000000000000000650000000064d5c35b000000000000000000000000000000000000000000000000000000000000000000000000019ec0270000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014c3e1ce0d9c3a3da1b9cb04d133ad4e3bbe1fab7e000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000050382b8fc794a9d02b01a05aab983d8bad95f36cc8f196fb0160aa0b1533ce8f8f3c7c375008ce701a75c7e788db8d8000000000000000000000000000000000c6a23cfbd5943b5afbdf504a5228ea920c2570140c8314310b712f65254efb8436aa6949100dea26055c12eb1e30e74"
	//
	//decodefirstInput, err := hexutil.Decode(firstInput)
	//abi, err := bindings.RollupMetaData.GetAbi()
	//require.NoError(t, err)
	//args, err := abi.Methods["commitBatch"].Inputs.Unpack(decodefirstInput[4:])
	//require.NoError(t, err)
	//// parse calldata to rollup batch data
	//fetchBatch := newRollupData(58, common.HexToHash("0x6f74f717059c77203c6518ab345f60757f3a9903f6331bb2c8ebcba02dab6735"), 1)
	//d := testNewDerivationClient(t)
	//err = parseBatch(args, fetchBatch)
	//require.NoError(t, err)
}

func TestDecodeChunk(t *testing.T) {

	var batch_json = "{\"version\":0,\"parentBatchHeader\":\"0x000000000000001cd5000000000000000000000000000000037ac7e7113944dba111bcb9cc6bb07236499686717a778fc2dee94e3c95e9c537c1cea06aa3f93eb6501b097391a6df751f49f8094161968acde577ab5373aa2f\",\"chunks\":[\"0x0100000000000090260000000065713f8c0000000000000000000000000000000000000000000000000000000000000000000000000098968000000000\",\"0x0100000000000090270000000065713f8d0000000000000000000000000000000000000000000000000000000000000000000000000098968000000000\",\"0x0100000000000090280000000065713f8e0000000000000000000000000000000000000000000000000000000000000000000000000098968000000000\",\"0x0100000000000090290000000065713f900000000000000000000000000000000000000000000000000000000000000000000000000098968000000000\",\"0x01000000000000902a0000000065713f910000000000000000000000000000000000000000000000000000000000000000000000000098968000000000\"],\"skippedL1MessageBitmap\":\"0x\",\"prevStateRoot\":\"0x2e5e1d0e6466f321f3e3840f30ecb7608d1256029da94911835b5e06f6dc38b8\",\"postStateRoot\":\"0x2e5e1d0e6466f321f3e3840f30ecb7608d1256029da94911835b5e06f6dc38b8\",\"withdrawRoot\":\"0x27ae5ba08d7291c96c8cbddcc148bf48a6d68c7974b94356f53754ef6171d757\",\"signatures\":[{\"version\":1,\"signer\":0,\"signerPubKey\":\"0x00000000000000000000000000000000095ad465c2895ee825c7d4f1b60a18734db57d4108369e47c6e3a94ee15846f825c06dad5d98f503bd31ece1d9f94b11000000000000000000000000000000000c5d6ba04bc9b9674dd2acbfc5caed3976c1b8be2ec90a03d78dffe924648b4fba82225aff43c744310c6a60185b75ac000000000000000000000000000000000fce6be001c871a11b9db1c6c15f0a6999de5646941a74486206dc784f0b3ffe11799212f3f44ef754b4a0f1ecf85639000000000000000000000000000000000b2f06634e5ea719682c30911c94dfb560f0b7656b5c34a871ea035e3fe7b041885420f8fe1e251f1cce5cdb7514869e\",\"signature\":\"0x050be97fd4b7ceb584997b1d2e47d5e96b9794772e97f02094a99f86db1c229cbc994ab4871d02588586bd55e524edc0072c6b479154390277c24d76acd6197c1e454028406f4b8e35ba0f7f9986459d293e4dbc3a224e89e1e0eda3d352ce8c\"},{\"version\":1,\"signer\":1,\"signerPubKey\":\"0x0000000000000000000000000000000010173aeac4ff317e8e60493f962b91dbd27614e1f6594e17d18a02968bd1fd698b6703092ab8622cd22d6948d9421156000000000000000000000000000000000801aea15697ab4d7a808be45377e4f0d2f54857fdc04031e476402ff16c66a6cbcc5f09a84bf85400c8afbabed006600000000000000000000000000000000015fc71b2c4e81148274e6169c9c9aace8c34fa6030547650242b6c32527dd23a996416e32640bce4f495a0afabc7dbb900000000000000000000000000000000088c4a0dffccc96bce47aef0e176b129457a5f3ae1651b132ddb418e9f7b5850a38c6fec1be6d169eb88dc1619648bf4\",\"signature\":\"0x12f38e4123ac97a630956b16ed99b2785fd6b79e5c860a5e072c781bad3f0d1f43bff5702bef1cf15bbe2d25cb1bb4b7172a14e01c6fcd02c322d6dfe28aab910aad9e74cca267b88472b7bab15f923bfcd73112cb8d1bb86b23f8f9348f4b07\"},{\"version\":1,\"signer\":2,\"signerPubKey\":\"0x0000000000000000000000000000000003fd9468a8ceffc1b696874517777ef8bfdc9a1bade95c480ee2624903e648c1caf01c65de5b4fda8876a3a0e8d9f0890000000000000000000000000000000004c02f3609a0f61d12fe737dcbb047d5253bd3ff905b55c0e0f932b476fd77d172a58b72ef0f506407870988dd6038220000000000000000000000000000000017fa5765899f60f7a58f8ccdaaa295cde55992231710672692ba6a71a4faa9572f728f438ded65576a570d57e19fd304000000000000000000000000000000001226138813bde98af3464ed03649d8c731bc4e5cb3d26b53bf7483f4105d18bbb3f19e23905119e156e7d003d2fd125c\",\"signature\":\"0x15dbef0514d64625da2003ae21bccfbb52009281f5a98549df44c6a848223bb08fc334b9e7e92a1ffcacac52e8dc7e52106f125eb4ea87138660a501bb7eaedb437908046ecafa6717aad16f52c02965dab76d2d1968a6f37bab029df655f68c\"},{\"version\":1,\"signer\":3,\"signerPubKey\":\"0x00000000000000000000000000000000109bf02a2636c0dc1968b0a50db77251eb090c3e9f51e2a2bc60c4ac72213f41f01f0a34e92c2e0625bd62e28e27edb500000000000000000000000000000000139969bd92522113c0615659874d1fae311ad8152d0584c7b57ffc14927067486dcf86413c5684fccc1163ee2d45c1c1000000000000000000000000000000000f172603f70a0730d100ad6d28bde477195987062e8ade83b82d093935d956ff20ca768c26263577b094f1cb756adc400000000000000000000000000000000010dde3acca00b4ff1b4976500a8f97e92246f43f78cadc95c4993dfc4f4c501c33d42a4bf52587f4931287b59623149c\",\"signature\":\"0x0cf613d3874638a2a0fc3ecc96ade95e704a8c3604770a14f09fb81bd4fde3563a21767e295c4d16c42b055ff89217a60b5acb1d0107620aaf102ee7a8889171a682e50f7bff8566ee27a0a77bd10e347dd7636447fe394b44c90f1a91a85f8e\"}]}"
	var batch eth.RPCRollupBatch
	err := json.Unmarshal([]byte(batch_json), &batch)
	require.NoError(t, err)
	str := "0x01000000000000902a0000000065713f910000000000000000000000000000000000000000000000000000000000000000000000000098968000000000"
	fmt.Println("str len:", len(str))
	fmt.Println("max uint8:", math.MaxUint8)
	rollupData := newRollupData(9999, common.BytesToHash([]byte{}), 0)
	err = parseBatch(batch, rollupData)
	if err != nil {
		fmt.Printf("parseBatch err:%+v\n", err)
	}
	require.NoError(t, err)
	fmt.Printf("rollupData:%+v\n", rollupData)
}

func TestName(t *testing.T) {
	abi, err := bindings.RollupMetaData.GetAbi()
	require.NoError(t, err)
	hexData := "0x4c4b9e4f00000000000000000000000000000000000000000000000000000000000000601d4ceff4b2335970615354f0a03e2124745d1c193d509e9109e4910b869448ce27ae5ba08d7291c96c8cbddcc148bf48a6d68c7974b94356f53754ef6171d7570000000000000000000000000000000000000000000000000000000000000059000000000000000000000000000000000000000000000000008cb3decea512e30f962b50492fee707a926cd3465d2ac9b2b9655553a915578d000000000000000000000000000000000000000000000000000000000000000000000000000000E"
	hexData = "0x16b799c9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000002201d4ceff4b2335970615354f0a03e2124745d1c193d509e9109e4910b869448ce0f199dc7fb956c94a69ba951785dae12d9d6c7ed3073dd5a5453151d9996a25127ae5ba08d7291c96c8cbddcc148bf48a6d68c7974b94356f53754ef6171d75700000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000059000000000000000000000000000000000000000000000000008cb3decea512e30f962b50492fee707a926cd3465d2ac9b2b9655553a915578d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003d010000000000000001000000006570805b0000000000000000000000000000000000000000000000000000000000000000000000000098968000010001000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000005bc55b7eb2a19d020541768ca2c88e9feed6df90edc34e7aac67e1c2ae0a2ae72e2b381671f72bf2067d74ab0c11a91000000000000000000000000000000000fbdc060a4fd3fb5923c5ff9a430acdba1fbc17136e76cb85af00b274dfeaed8ce982afd68ffea340dd71c1391e31ad3"
	txData, err := hexutil.Decode(hexData)
	require.NoError(t, err)
	args, err := abi.Methods["commitBatch"].Inputs.Unpack(txData[4:])
	rollupBatchData := args[0].(struct {
		Version                uint8     "json:\"version\""
		ParentBatchHeader      []uint8   "json:\"parentBatchHeader\""
		Chunks                 [][]uint8 "json:\"chunks\""
		SkippedL1MessageBitmap []uint8   "json:\"skippedL1MessageBitmap\""
		PrevStateRoot          [32]uint8 "json:\"prevStateRoot\""
		PostStateRoot          [32]uint8 "json:\"postStateRoot\""
		WithdrawalRoot         [32]uint8 "json:\"withdrawalRoot\""
		Signature              struct {
			Version   *big.Int   "json:\"version\""
			Signers   []*big.Int "json:\"signers\""
			Signature []uint8    "json:\"signature\""
		} "json:\"signature\""
	})

	var chunks []hexutil.Bytes
	for _, chunk := range rollupBatchData.Chunks {
		chunks = append(chunks, chunk)
	}
	batch := eth.RPCRollupBatch{
		Version:                uint(rollupBatchData.Version),
		ParentBatchHeader:      rollupBatchData.ParentBatchHeader,
		Chunks:                 chunks,
		SkippedL1MessageBitmap: rollupBatchData.SkippedL1MessageBitmap,
		PrevStateRoot:          common.BytesToHash(rollupBatchData.PrevStateRoot[:]),
		PostStateRoot:          common.BytesToHash(rollupBatchData.PostStateRoot[:]),
		WithdrawRoot:           common.BytesToHash(rollupBatchData.WithdrawalRoot[:]),
	}
	rollupData := newRollupData(9999, common.BytesToHash([]byte{}), 0)
	err = parseBatch(batch, rollupData)
	require.NoError(t, err)
	fmt.Println(args)
}

func TestNameT(t *testing.T) {
	s := []int{1, 2, 3}
	fmt.Println(s[0:0])
}
